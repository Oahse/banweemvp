# SKU Auto-Generation Feature

## Overview
SKU (Stock Keeping Unit) is now automatically generated by the backend when creating products, eliminating the need for manual SKU entry.

## SKU Format

### Pattern
```
{PRODUCT_PREFIX}-{PRODUCT_ID}-{VARIANT_INDEX}
```

### Components
1. **Product Prefix** - First 3 characters of product name (uppercase, spaces removed)
2. **Product ID** - First 8 characters of the product UUID
3. **Variant Index** - Zero-based index of the variant (0, 1, 2, ...)

### Examples

**Product: "Organic Shea Butter"**
- Product ID: `550e8400-e29b-41d4-a716-446655440000`
- Variant 0: `ORG-550e8400-0`
- Variant 1: `ORG-550e8400-1`
- Variant 2: `ORG-550e8400-2`

**Product: "Premium Coffee"**
- Product ID: `7c9e6679-7425-40de-944b-e07fc1f90ae7`
- Variant 0: `PRE-7c9e6679-0`
- Variant 1: `PRE-7c9e6679-1`

**Product: "T-Shirt"**
- Product ID: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- Variant 0: `T-S-a1b2c3d4-0`
- Variant 1: `T-S-a1b2c3d4-1`

## Implementation

### Backend Changes

#### Schema Update (`schemas/product.py`)
```python
class ProductVariantCreate(BaseModel):
    sku: Optional[str] = None  # Optional - auto-generated if not provided
    name: str
    base_price: float
    sale_price: Optional[float] = None
    stock: int = 0
    attributes: Optional[Dict[str, Any]] = {}
    image_urls: Optional[List[str]] = []  # jsDelivr CDN URLs
```

#### Service Update (`services/products.py`)
```python
for v_idx, variant_data in enumerate(product_data.variants):
    # Auto-generate SKU
    product_prefix = db_product.name[:3].upper().replace(' ', '')
    auto_sku = f"{product_prefix}-{str(db_product.id)[:8]}-{v_idx}"
    
    db_variant = ProductVariant(
        product_id=db_product.id,
        sku=variant_data.sku if variant_data.sku else auto_sku,
        # ... other fields
    )
```

### Frontend Changes

#### Removed SKU Input
- SKU field removed from variant form
- Added helper text: "SKU will be auto-generated by the system"
- Validation no longer checks for SKU

#### Form Data
```typescript
// Frontend sends (no SKU)
{
  name: "Variant Name",
  base_price: 29.99,
  sale_price: 24.99,
  stock: 100,
  image_urls: ["https://cdn.jsdelivr.net/gh/..."]
}

// Backend generates SKU and creates variant
```

## Benefits

### For Users
- ✅ **No Manual Entry** - SKU generated automatically
- ✅ **Consistent Format** - All SKUs follow same pattern
- ✅ **No Duplicates** - UUID-based ensures uniqueness
- ✅ **Faster Product Creation** - One less field to fill
- ✅ **No Errors** - Can't enter invalid SKU format

### For System
- ✅ **Guaranteed Uniqueness** - Based on product UUID
- ✅ **Traceable** - SKU contains product ID
- ✅ **Sortable** - Variants indexed sequentially
- ✅ **Readable** - Product prefix makes it identifiable
- ✅ **Scalable** - Works for unlimited products/variants

## SKU Generation Logic

### Code Implementation
```python
def generate_sku(product_name: str, product_id: UUID, variant_index: int) -> str:
    """
    Generate SKU in format: {PREFIX}-{ID}-{INDEX}
    
    Args:
        product_name: Name of the product
        product_id: UUID of the product
        variant_index: Index of the variant (0-based)
    
    Returns:
        Generated SKU string
    
    Examples:
        >>> generate_sku("Organic Shea Butter", uuid, 0)
        'ORG-550e8400-0'
        
        >>> generate_sku("Premium Coffee", uuid, 1)
        'PRE-7c9e6679-1'
    """
    product_prefix = product_name[:3].upper().replace(' ', '')
    return f"{product_prefix}-{str(product_id)[:8]}-{variant_index}"
```

### Edge Cases

**Short Product Names (< 3 chars)**
- "TV" → `TV-550e8400-0`
- "A" → `A-550e8400-0`

**Product Names with Spaces**
- "T Shirt" → `T-S-550e8400-0` (space removed)
- "Big Sale" → `BIG-550e8400-0`

**Special Characters**
- "Café Latte" → `CAF-550e8400-0` (special chars handled)
- "100% Pure" → `100-550e8400-0`

## Database Schema

### ProductVariant Model
```python
class ProductVariant(BaseModel):
    sku: str  # Auto-generated, unique
    name: str
    base_price: float
    sale_price: Optional[float]
    stock: int
    # ... other fields
```

### Constraints
- SKU is unique across all variants
- SKU is indexed for fast lookups
- SKU cannot be null (always generated)

## API Examples

### Create Product Request
```json
POST /api/v1/products
{
  "name": "Organic Shea Butter",
  "description": "100% pure shea butter",
  "category_id": "uuid",
  "variants": [
    {
      "name": "Small (100g)",
      "base_price": 12.99,
      "stock": 50,
      "image_urls": ["https://cdn.jsdelivr.net/gh/..."]
    },
    {
      "name": "Large (500g)",
      "base_price": 49.99,
      "stock": 30,
      "image_urls": ["https://cdn.jsdelivr.net/gh/..."]
    }
  ]
}
```

### Response
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Organic Shea Butter",
    "variants": [
      {
        "id": "variant-uuid-1",
        "sku": "ORG-550e8400-0",  // Auto-generated
        "name": "Small (100g)",
        "base_price": 12.99
      },
      {
        "id": "variant-uuid-2",
        "sku": "ORG-550e8400-1",  // Auto-generated
        "name": "Large (500g)",
        "base_price": 49.99
      }
    ]
  }
}
```

## Migration Notes

### Existing Products
- Existing products keep their current SKUs
- Only new products get auto-generated SKUs
- Manual SKU entry still supported (if provided in API)

### Backward Compatibility
```python
# If SKU is provided, use it
sku = variant_data.sku if variant_data.sku else auto_sku

# This allows:
# 1. Auto-generation for new products (no SKU provided)
# 2. Manual SKU for special cases (SKU provided)
# 3. Backward compatibility with existing code
```

## Testing

### Test Cases
1. Create product without SKU → Verify auto-generated
2. Create product with manual SKU → Verify manual SKU used
3. Create product with multiple variants → Verify sequential indexing
4. Check SKU uniqueness → No duplicates
5. Verify SKU format → Matches pattern
6. Test with short product names → Handles correctly
7. Test with special characters → Sanitizes properly

### Verification
```bash
# Check generated SKUs in database
SELECT sku, name FROM product_variants ORDER BY created_at DESC LIMIT 10;
```

## Future Enhancements

- [ ] Custom SKU prefix per supplier
- [ ] SKU format configuration in settings
- [ ] Bulk SKU regeneration tool
- [ ] SKU validation rules
- [ ] SKU search optimization
- [ ] Barcode generation from SKU
- [ ] SKU history tracking
- [ ] Import/export with SKU mapping

## Related Features

- **Barcode Generation** - SKU used for barcode creation
- **Inventory Management** - SKU used for stock tracking
- **Order Processing** - SKU identifies products in orders
- **Analytics** - SKU used for sales reporting

## Support

If SKU generation fails:
1. Check product name is not empty
2. Verify product ID is valid UUID
3. Check variant index is valid integer
4. Review database constraints
5. Check for duplicate SKU conflicts
